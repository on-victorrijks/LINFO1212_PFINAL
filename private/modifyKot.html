<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{page.title}}</title>
  <meta name="description" content="{{page.description}}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/css/vars.css">
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/menu.css">
  <link rel="stylesheet" href="/css/forms.css">
  <link rel="stylesheet" href="/css/modifyKot.css">

</head>
<body>

    <div class="menuContainer">
        <div class="fixedBtn" id="mobileOpen">
            <img src="/imgs/icons/menu_black_24dp.svg" alt="logo"/>
        </div>
        <div class="fixedBtn" id="mobileClose" hidden="true">
            <img src="/imgs/icons/close_black_24dp.svg" alt="logo"/>
        </div>
    
        <div class="menu" id="menu" mobileHidden="true">
    
            <div class="menuElms">
    
                <div class="menuTopElements">
                    <div class="logo">
                        <img src="/imgs/logo.svg" id="logo_long" alt="logo"/>
                        <img src="/imgs/logo_mini.svg" id="logo_mini" alt="logo_mini"/>
                    </div>
                    {{#user}}
                    <a class="user" href="/account">
                        <div class="userImage">
                            <img src="https://localhost:8080/users/profilPicture/{{user._id}}" alt="user"/>
                        </div>
                        <div class="userText">
                            <h1>{{user.firstname}} {{user.lastname}}</h1>
                            <h2>Mon compte</h2>
                        </div>
                    </a>
                    {{/user}}
                    {{^user}}
                    <a class="registerorlogin" href="/login">
                        <h1>Se connecter / S'inscrire</h1>
                    </a>
                    {{/user}}
                </div>
                <div class="menuOptions">
    
                    <a class="option" selected="{{menu.selectedPage.home}}" href="/">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/search_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/search_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Accueil</h2>
                        </div>
                    </a>

                    {{#user}}
                    {{/user}}
                    {{^user}}
                    <a class="option" selected="{{menu.selectedPage.presentation}}" href="/presentation">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/view_module_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/view_module_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Présentation</h2>
                        </div>
                    </a>
                    {{/user}}
                    
                    {{#user}}
                    {{#isResident}}
                    <a class="option" selected="{{menu.selectedPage.favs}}" href="/kot/favs">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/favorite_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/favorite_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Mes favoris</h2>
                        </div>
                    </a>
                    {{/isResident}}
                    {{/user}}
    
                    {{#user}}
                    {{#isLandlord}}
                    <a class="option" selected="{{menu.selectedPage.publish}}" href="/kot/create">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/add_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/add_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Publier un kot</h2>
                        </div>
                    </a>
                    <a class="option" selected="{{menu.selectedPage.mykots}}" href="/kot/my">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/home_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/home_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Mes kots</h2>
                        </div>
                    </a>
                    {{/isLandlord}}
                    {{/user}}
    
                    <a class="option" selected="{{menu.selectedPage.contact}}" href="/contact">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/call_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/call_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Contact</h2>
                        </div>
                    </a>
    
                </div>
                
                {{#user}}
                <div class="otherBtns">
                    <a href="/account/settings">
                        <img src="/imgs/icons/settings_black_24dp.svg" alt="settings"/>
                    </a>
                    <a href="/disconnect">
                        <img src="/imgs/icons/logout_black_24dp.svg" alt="disconnect"/>
                    </a>
                </div>
                {{/user}}
    
            </div>
            
        </div>
    </div>

    <div class="g-background">

        <div class="g-content">

            {{#kot}}

            <div class="g-topBar">
                <div class="g-topTitle">
                    <h1>Modifier un kot - <b>{{kot.title}}</b></h1>
                </div>
            </div>

            <div class="g-info-box">
                <img src="/imgs/icons/info_accentColor_24dp.svg">
                <p>
                    Attention : Après une modification de l'annonce, il est signalé sur celle-ci qu'elle a été modifié. Nous faisons ceci pour éviter toutes confusions entre un propriétaire et un locataire.
                </p>
            </div>

            <form action="/api/kot/modify" method="POST" enctype="multipart/form-data" id="modifyKotForm">
        
                <input type="hidden" name="kotID" value="{{kot._id}}"/>

                <div class="form-alert" id="form-alert" hidden>
                    <img src="/imgs/icons/report_accentColor_24dp.svg">
                    <p id="form-alert-message"></p>
                </div>
        
                <label for="title" required>Titre</label>
                <input type="text" name="title" placeholder="Titre" required value="{{kot.title}}"/>
        
                <label for="description" required>Description</label>
                <textarea name="description" placeholder="Description" required>{{kot.description}}</textarea>
        
                <label for="localisation" required>Localisation</label>
                <div class="searchLocalisation">
                    <div class="form-searchBar">
                        <input type="text" name="localisation" placeholder="Localisation" id="searchLocalisationField" required value="{{kot.location.address}}"/>
                        <button type="button" id="searchLocalisationButton">Chercher</button>
                    </div>
                    <h1 class="searchLocalisationResults" id="searchLocalisationResults">
                        {{kot.location.address}}
                    </h1>
                    <input type="hidden" name="localisation_address" id="localisation_address" required value="{{kot.location.address}}">
                    <input type="hidden" name="localisation_lat" id="localisation_lat" required value="{{kot.location.lat}}">
                    <input type="hidden" name="localisation_lng" id="localisation_lng" required value="{{kot.location.lng}}">
                </div>
        
                <div class="addPictures">
                    <input type="file" name="pictures" id="pictures-input" multiple accept="image/jpeg, image/png" onchange="previewImage(event)">
                    <div class="addPictures-gallery">
                        <div class="addPictures-gallery-slider" id="addPictures-gallery">
                            <label class="addFileBtn" for="pictures-input">
                                <h2>Ajouter des images</h2>
                            </label>
                            {{#kot.pictures}}
                            <div class="image" id="{{index}}" {{#isMainImage}}main="true"{{/isMainImage}}>
                                <img src="https://localhost:8080/users/kots/images/{{kot._id}}_{{imageName}}">
                                <div class="buttonsContainer">
                                    <button type="button" class="remove" onclick="switchBinStatus('{{imageName}}', {{index}})"></button>
                                    <button type="button" class="setMain" onclick="setMainPictureName('{{imageName}}', {{index}})"></button>
                                </div>
                            </div>
                            {{/kot.pictures}}
                        </div>
                    </div>
                    <input type="hidden" name="mainPictureName" id="mainPictureName"  value="{{formPreloader.mainPictureName}}">
                    <input type="hidden" name="binNames" id="binNames">
                </div>
                
                <label for="isOpen" required>Le kot est disponible (demandes possibles)</label>
                <select name="isOpen" required>
                  <option value="true"  {{#formPreloader.isOpen.opt1}}selected="true"{{/formPreloader.isOpen.opt1}}>Oui</option>
                  <option value="false" {{#formPreloader.isOpen.opt2}}selected="true"{{/formPreloader.isOpen.opt2}}>Non</option>
                </select>
        
                <label for="availability" required>Date de disponibilité</label>
                <input type="date" name="availability" required min="2021-01-12" value="{{formPreloader.availability}}"/>
        
                <hr>
        
                <label for="isCollocation" required>Est-ce une collocation</label>
                <select name="isCollocation" required>
                  <option value="true"  {{#formPreloader.isCollocation.opt1}}selected="true"{{/formPreloader.isCollocation.opt1}}>Oui</option>
                  <option value="false" {{#formPreloader.isCollocation.opt2}}selected="true"{{/formPreloader.isCollocation.opt2}}>Non</option>
                </select>
        
                <label for="maxTenant" required>Nombres de places de collocation disponibles</label>
                <input type="number" name="maxTenant" placeholder="3" min="0" max="25" required value="{{kot.collocationData.maxTenant}}"/>
        
                <hr>
        
                <label for="basePrice" required>Prix sans les charges</label>
                <input type="number" name="basePrice" placeholder="350" min="0" max="20000" required value="{{kot.basePrice}}"/>
        
                <label for="chargePrice" required>Charges supplémentaires</label>
                <input type="number" name="chargePrice" placeholder="50" min="0" max="20000" required value="{{kot.chargePrice}}"/>
                
                <hr>
        
                <label for="bedrooms" required>Nombre de chambres</label>
                <input type="number" name="bedrooms" placeholder="1" min="1" max="25" required value="{{kot.bedrooms}}"/>
        
                <label for="bathrooms" required>Nombre de salle de bain</label>
                <input type="number" name="bathrooms" placeholder="1" min="0" max="25" required value="{{kot.bathrooms}}"/>
        
                <label for="toilets" required>Nombre de toilettes</label>
                <input type="number" name="toilets" placeholder="1" min="0" max="25" required value="{{kot.toilets}}"/>
        
                <label for="type" required>Type de batiment</label>
                <select name="type" required>
                  <option value="flat"  {{#formPreloader.type.opt1}}selected="true"{{/formPreloader.type.opt1}}>Appartement</option>
                  <option value="house" {{#formPreloader.type.opt2}}selected="true"{{/formPreloader.type.opt2}}>Maison</option>
                </select>
                
                <hr>
        
                <label for="surface" required>Surface en m²</label>
                <input type="number" name="surface" placeholder="25" min="1" max="1000" required value="{{kot.surface}}"/>
        
                <label for="floors" required>Nombre d'étages</label>
                <input type="number" name="floors" placeholder="1" min="1" max="10" required value="{{kot.floors}}"/>
        
                <label for="constructionYear" required>Année de construction</label>
                <input type="number" name="constructionYear" placeholder="2010" min="1900" max="2021" required value="{{kot.constructionYear}}"/>
        
                <label for="parking" required>Nombre de place de parking</label>
                <input type="number" name="parking" placeholder="0" min="0" max="25" required value="{{kot.parking}}"/>
        
                <hr>
        
                <label for="furnished" required>Meubles disponibles</label>
                <select name="furnished" required>
                  <option value="true"  {{#formPreloader.furnished.opt1}}selected="true"{{/formPreloader.furnished.opt1}}>Oui</option>
                  <option value="false" {{#formPreloader.furnished.opt2}}selected="true"{{/formPreloader.furnished.opt2}}>Non</option>
                </select>
        
                <label for="petFriendly" required>Règlement animaux</label>
                <select name="petFriendly" required>
                  <option value="false" {{#formPreloader.petFriendly.opt1}}selected="true"{{/formPreloader.petFriendly.opt1}}>Pas d'animaux</option>
                  <option value="small" {{#formPreloader.petFriendly.opt2}}selected="true"{{/formPreloader.petFriendly.opt2}}>Petits animaux</option>
                  <option value="big"   {{#formPreloader.petFriendly.opt3}}selected="true"{{/formPreloader.petFriendly.opt3}}>Grands animaux</option>
                </select>
          
                <label for="garden" required>Présence d'un jardin</label>
                <select name="garden" required>
                  <option value="true"  {{#formPreloader.garden.opt1}}selected="true"{{/formPreloader.garden.opt1}}>Oui</option>
                  <option value="false" {{#formPreloader.garden.opt2}}selected="true"{{/formPreloader.garden.opt2}}>Non</option>
                </select>
        
                <label for="terrace" required>Présence d'une terrace</label>
                <select name="terrace" required>
                  <option value="true"  {{#formPreloader.terrace.opt1}}selected="true"{{/formPreloader.terrace.opt1}}>Oui</option>
                  <option value="false" {{#formPreloader.terrace.opt2}}selected="true"{{/formPreloader.terrace.opt2}}>Non</option>
                </select>
        
                <button type="button" class="submit" id="modify_btn">Modifier</button>
            </form>
            {{/kot}}
                
        </div>

    </div>

</body>

<script>

    const addPicturesGallery = document.getElementById("addPictures-gallery");
    const picturesInput = document.getElementById("pictures-input");
    const mainPictureNameInput = document.getElementById("mainPictureName");
    const binInput = document.getElementById("binNames");

    function switchBinStatus(toDelName, divID){
        const isInBin = document.getElementById(divID).hasAttribute("inBin");
        const storedName = "|"+toDelName;
        if(isInBin){
            document.getElementById(divID).removeAttribute("inBin");
            binInput.value = binInput.value.replace(storedName, "");
        } else {
            document.getElementById(divID).setAttribute("inBin", "true");
            binInput.value += storedName;
        }
    }

    function removeImage(toDelName, divID){
        var files = picturesInput.files; 
        var fileBuffer = new DataTransfer();

        for (let i = 0; i < files.length; i++) {
            if (files[i].name === toDelName){
                document.getElementById(divID).remove();
            } else {
                fileBuffer.items.add(files[i]);
            }
        }
        
        picturesInput.files = fileBuffer.files;
    }

    let previewImageID = {{kot.pictures.length}};

    function setMainPictureName(toSetMainName, divID){
        mainPictureNameInput.value = toSetMainName;
        const oldMain = document.querySelector('#addPictures-gallery .image[main="true"]');
        if (oldMain) oldMain.removeAttribute("main");
        document.getElementById(divID).setAttribute("main", "true");
    }

    function previewImage(event) {

        const newFiles = event.target.files;
        for (var i = 0; i < newFiles.length; i++) {

            const file = newFiles[i];

            var image = document.createElement("img");
            image.src = URL.createObjectURL(file);

            var buttonRemove = document.createElement("button");
            buttonRemove.setAttribute("type", "button");
            buttonRemove.setAttribute("class", "remove");
            buttonRemove.setAttribute("onClick", "removeImage('"+file.name+"', "+previewImageID+")");

            var buttonSetMain = document.createElement("button");
            buttonSetMain.setAttribute("type", "button");
            buttonSetMain.setAttribute("class", "setMain");
            buttonSetMain.setAttribute("onClick", "setMainPictureName('"+file.name+"', "+previewImageID+")")

            var buttonsContainer = document.createElement("div");
            buttonsContainer.setAttribute("class", "buttonsContainer");

            buttonsContainer.appendChild(buttonRemove);
            buttonsContainer.appendChild(buttonSetMain);

            var imageContainer = document.createElement("div");
            imageContainer.setAttribute("class", "image");
            imageContainer.setAttribute("id", previewImageID);
            imageContainer.appendChild(image);
            imageContainer.appendChild(buttonsContainer);

            addPicturesGallery.appendChild(imageContainer);
            previewImageID += 1;

        }
    };

    const searchLocalisationField = document.getElementById("searchLocalisationField");
    const searchLocalisationResults = document.getElementById("searchLocalisationResults");

    const searchLocalisationInputAddress = document.getElementById("localisation_address");
    const searchLocalisationInputLat = document.getElementById("localisation_lat");
    const searchLocalisationInputLng = document.getElementById("localisation_lng");

    document.getElementById("searchLocalisationButton").addEventListener("click", searchLocalisation);
    document.getElementById("modify_btn").addEventListener("click", (e) => {
        if(
            searchLocalisationInputAddress.value!=="" &&
            searchLocalisationInputLat.value!=="" &&
            searchLocalisationInputLng.value!==""
        ){
            document.getElementById("modifyKotForm").submit();
        } else {
            document.getElementById("form-alert").removeAttribute("hidden");
            document.getElementById("form-alert-message").innerHTML = "Veuillez spécifier une adresse valide";
            document.querySelector(".g-background").scrollTo(0,0);
        } 
    });

    async function searchLocalisation() {
        const value = searchLocalisationField.value;

        if(value!==""){

            const url = "https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyBvHIznYCzznbkXRcZOt4MuvKxthkGcaSU&region=be&address="+value+" LLN";

            searchLocalisationResults.innerHTML = "Recherche..."

            fetch(url)
            .then(response => response.json())
            .then(data => {
                const status = data.status;
                if(status==="OK"){
                    const results = data.results;
                    if(results.length >= 1){
                        const formatted_address = results[0]["formatted_address"];
                        const lat = results[0]["geometry"]["location"]["lat"];
                        const lng = results[0]["geometry"]["location"]["lng"];

                        searchLocalisationInputAddress.value = formatted_address;
                        searchLocalisationInputLat.value = lat;
                        searchLocalisationInputLng.value = lng;

                        searchLocalisationResults.innerHTML = formatted_address
                    } else {
                        searchLocalisationResults.innerHTML = "Aucun résultat trouvé"
                    }
                }
            });

        }

    }
</script>
<script src="/js/menu.js"></script>