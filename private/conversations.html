<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{page.title}}</title>
  <meta name="description" content="{{page.description}}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/css/vars.css">
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/menu.css">
  <link rel="stylesheet" href="/css/conversations.css">

</head>
<body>

    <div class="menuContainer">
        <div class="fixedBtn" id="mobileOpen">
            <img src="/imgs/icons/menu_black_24dp.svg" alt="logo"/>
        </div>
        <div class="fixedBtn" id="mobileClose" hidden="true">
            <img src="/imgs/icons/close_black_24dp.svg" alt="logo"/>
        </div>
    
        <div class="menu" id="menu" mobileHidden="true">
    
            <div class="menuElms">
    
                <div class="menuTopElements">
                    <a class="logo" href="/">
                        <img src="/imgs/logo.svg" id="logo_long" alt="logo"/>
                        <img src="/imgs/logo_mini.svg" id="logo_mini" alt="logo_mini"/>
                    </a>
                    {{#user}}
                    <a class="user" href="/account">
                        <div class="userImage">
                            <img src="https://localhost:8080/users/profilPicture/{{user._id}}" alt="user"/>
                        </div>
                        <div class="userText">
                            <h1>{{user.firstname}} {{user.lastname}}</h1>
                            <h2>Mon compte</h2>
                        </div>
                    </a>
                    {{/user}}
                    {{^user}}
                    <a class="registerorlogin" href="/login">
                        <h1>Se connecter / S'inscrire</h1>
                    </a>
                    {{/user}}
                </div>
                <div class="menuOptions">
    
                    <a class="option" selected="{{menu.selectedPage.home}}" href="/">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/search_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/search_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Accueil</h2>
                        </div>
                    </a>

                    {{#user}}
                    <a class="option" selected="{{menu.selectedPage.conversations}}" href="/conversations">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/question_answer_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/question_answer_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Messages</h2>
                        </div>
                    </a>
                    {{/user}}
                    {{^user}}
                    <a class="option" selected="{{menu.selectedPage.presentation}}" href="/presentation">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/view_module_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/view_module_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Présentation</h2>
                        </div>
                    </a>
                    {{/user}}
                    
                    {{#user}}
                    {{#isResident}}
                    <a class="option" selected="{{menu.selectedPage.favs}}" href="/kot/favs">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/favorite_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/favorite_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Mes favoris</h2>
                        </div>
                    </a>
                    {{/isResident}}
                    {{/user}}

                    {{#user}}
                    {{#isLandlord}}
                    <a class="option" selected="{{menu.selectedPage.publish}}" href="/kot/create">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/add_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/add_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Publier un kot</h2>
                        </div>
                    </a>
                    <a class="option" selected="{{menu.selectedPage.mykots}}" href="/kot/my">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/home_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/home_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Mes kots</h2>
                        </div>
                    </a>
                    {{/isLandlord}}
                    {{/user}}
    
                    <a class="option" selected="{{menu.selectedPage.contact}}" href="/contact">
                        <div class="optionImage">
                            <img id="unselected" alt="menuOption" src="/imgs/icons/call_black_24dp.svg"/>
                            <img id="selected"   alt="menuOption" src="/imgs/icons/call_black_24dp_selected.svg"/>
                        </div>
                        <div class="optionName">
                            <h2>Contact</h2>
                        </div>
                    </a>
    
                </div>
                
                {{#user}}
                <div class="otherBtns">
                    <a href="/account/settings">
                        <img src="/imgs/icons/settings_black_24dp.svg" alt="settings"/>
                    </a>
                    <a href="/disconnect">
                        <img src="/imgs/icons/logout_black_24dp.svg" alt="disconnect"/>
                    </a>
                </div>
                {{/user}}
    
            </div>
            
        </div>
    </div>

    <div class="g-background">

        <input type="hidden" id="connectedUserID" value="{{user._id}}">

        <div class="g-content flexColumn blockHeight">

            <div class="g-topBar">
                <div class="g-topTitle">
                    <h1>Mes conversations</b></h1>
                </div>
            </div>

            <div class="browsersContainer">

                <div class="conversationsBrowser">

                    {{#conversations}}
                    <div class="cB-conversation" 
                    id="conv_{{_id}}"
                    onClick="setConversation('conv_{{_id}}')"
                    convID="{{_id}}"
                    convName="{{conv_name}}"
                    isSelected="false"
                    >
                        <div class="cB-conversation-image">
                            {{#conv_image}}
                            <img src="https://localhost:8080/users/profilPicture/{{.}}"/>
                            {{/conv_image}}
                        </div>
                        <div class="cB-conversation-text">
                            <h1>{{conv_name}}</h1>
                            <h2>{{conv_lastmessage}}</h2>
                        </div>
                    </div>
                    {{/conversations}}

                </div>

                <div class="conversationWindow">
                    <div class="cW-topBar">
                        <h1 id="dyn_convName"></h1>
                    </div>
                    <div class="cW-messagesBrowser" id="cW-messagesBrowser">

                    </div>
                    <div class="cW-writeMessage">
                        <textarea name="message" id="messageInput" placeholder="Ecrivez un message" required></textarea>
                        <button type="button" id="sendMessageButton">
                            <img src="/imgs/icons/send_white_24dp.svg"/>
                        </button>
                        <input type="hidden" id="dyn_convID" value="">
                    </div>
                </div>

            </div>

        </div>

    </div>


</body>
<script src="/js/menu.js"></script>
<script>
// Connected user data
const connectedUserID = document.getElementById("connectedUserID").value;

// Dyn data
const messagesContainer = document.getElementById("cW-messagesBrowser");
const dyn_convName      = document.getElementById("dyn_convName");
const dyn_convID        = document.getElementById("dyn_convID");
const dyn_messageInput  = document.getElementById("messageInput");

function setConversation(conversationInformationsContainerID) {

    const informationsContainer = document.getElementById(conversationInformationsContainerID);
    const convID     = informationsContainer.getAttribute("convID");
    const convName   = informationsContainer.getAttribute("convName");
    const isSelected = informationsContainer.getAttribute("isSelected");

    const previouslySelectedConversation = document.querySelector(".cB-conversation[isSelected='true']");
    if(previouslySelectedConversation) previouslySelectedConversation.setAttribute("isSelected", "false");

    informationsContainer.setAttribute("isSelected", "true");
    dyn_convName.innerHTML = convName;
    dyn_convID.value = convID;
    
}

document.getElementById("sendMessageButton").addEventListener("click", sendMessage);

async function sendMessage(){
    const message = dyn_messageInput.value;
    const convID  = dyn_convID.value;

    const data = {
        "message": message,
        "conversationID": convID
    };

    await fetch('https://localhost:8080/api/sendMessage', {
        method: 'post',
        mode: 'cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(result => {
        const error = result.error;
        if(!error){
            dyn_messageInput.value = "";
            createUIMessage(message);
        } else {
            console.error('Error:', error); //FIX SHOW ERROR
        }
    })
    .catch((error) => {
        console.error('Error:', error); //FIX SHOW ERROR
    });

}

function createUIMessage(message){

    const newUIMessage = document.createElement('div');
    newUIMessage.setAttribute("class", "cW-message");
    newUIMessage.setAttribute("fromUser", "true");

    // Image
    const NUIMSG_userImage = document.createElement('div');
    NUIMSG_userImage.setAttribute("class", "cW-userImage");

    const NUIMSG_userImageContainer = document.createElement('div');
    NUIMSG_userImageContainer.setAttribute("class", "cW-userImageContainer");

    const NUIMSG_userImage_img = document.createElement('img');
    NUIMSG_userImage_img.src = "https://localhost:8080/users/profilPicture/" + connectedUserID;

    NUIMSG_userImageContainer.appendChild(NUIMSG_userImage_img);
    NUIMSG_userImage.appendChild(NUIMSG_userImageContainer);

    // Text
    const NUIMSG_messageText = document.createElement('div');
    NUIMSG_messageText.setAttribute("class", "cW-messageText");

    const NUIMSG_messageText_message = document.createElement('p');
    NUIMSG_messageText_message.innerHTML = message;

    const NUIMSG_messageText_time = document.createElement('h5');
    NUIMSG_messageText_time.innerHTML = "Envoyé";

    NUIMSG_messageText.appendChild(NUIMSG_messageText_message);
    NUIMSG_messageText.appendChild(NUIMSG_messageText_time);

    // Compiling
    newUIMessage.appendChild(NUIMSG_userImage);
    newUIMessage.appendChild(NUIMSG_messageText);

    // Adding to UI
    messagesContainer.appendChild(newUIMessage);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

}
</script>